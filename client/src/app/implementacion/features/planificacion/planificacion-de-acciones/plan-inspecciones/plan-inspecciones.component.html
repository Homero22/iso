<!-- Boton para salir del formulario -->
<div class="flex justify-start">
  <button-back
    *ngIf="registrando"
    (click)="cancelarRegistro()"
    [title]="'Regresar'"
    onkeypress=""
  ></button-back>
</div>
@if (rows.length ===0 && !registrando) {

<div class="text-center py-6 bg-gray-100 rounded-lg">
  <h2 class="text-xl font-semibold mb-2">¡No tienes un plan registrado aún!</h2>
  <p class="text-gray-600 mb-4">
    Empieza creando uno, llenando los datos a continuación.
  </p>
  <img
    src="https://static.vecteezy.com/system/resources/previews/013/488/543/non_2x/flat-no-data-concept-outline-design-style-minimal-illustration-for-landing-page-web-banner-infographics-hero-images-vector.jpg"
    alt="No hay datos"
    width="300"
    class="mx-auto mb-4 rounded"
  />
  <button-save
    [title]="'Empezar a Registrar'"
    (click)="empezarRegistro()"
    onkeypress=""
  ></button-save>
</div>
} @if ( registrando ) {

<form
  class="border p-6 rounded-lg shadow-md bg-white"
  (submit)="addRow($event)"
>
  <div class="row">
    <div class="col-6 pe-2 mt-3 flex flex-col">
      <label for="acciones" class="block mb-1 text-sm font-medium text-gray-700"
        >Acciones</label
      >
      <textarea
        [(ngModel)]="newRow.descripcion"
        placeholder="Acciones"
        name="descripcion"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 ps-2 mt-3 flex flex-col">
      <label for="recursos" class="block mb-1 text-sm font-medium text-gray-700"
        >Recursos</label
      >
      <textarea
        [(ngModel)]="newRow.recursos"
        placeholder="Recursos"
        name="recursos"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 pe-2 mt-3 flex flex-col">
      <label
        for="responsable"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Responsable</label
      >
      <textarea
        [(ngModel)]="newRow.responsable"
        placeholder="Responsable"
        name="responsable"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 ps-2 mt-3 flex flex-col">
      <label
        for="criteriosExito"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Criterios de éxito</label
      >
      <textarea
        [(ngModel)]="newRow.criterios_exito"
        placeholder="Criterios de éxito"
        name="criterios_exito"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 pe-2 mt-3 flex flex-col">
      <label for="metodos" class="block mb-1 text-sm font-medium text-gray-700"
        >Métodos</label
      >
      <textarea
        [(ngModel)]="newRow.metodos"
        placeholder="Métodos"
        name="metodos"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 ps-2 mt-3 flex flex-col">
      <label for="alcance" class="block mb-1 text-sm font-medium text-gray-700"
        >Alcance</label
      >
      <textarea
        [(ngModel)]="newRow.alcance"
        placeholder="Alcance"
        name="alcance"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 pe-2 mt-3 flex flex-col">
      <label
        for="accionRevision"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Acción de Revisión</label
      >
      <textarea
        [(ngModel)]="newRow.accion_revision"
        placeholder="Acciones de Revisión"
        name="accion_revision"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 ps-2 mt-3 flex flex-col">
      <label
        for="responsableRevision"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Responsable Revisión</label
      >
      <textarea
        [(ngModel)]="newRow.responsable_revision"
        placeholder="Responsable Revisión"
        name="responsable_revision"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        rows="2"
      ></textarea>
    </div>
    <div class="col-6 pe-2 mt-3 flex flex-col">
      <label
        for="accionesPlanificadas"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Acciones Planificadas</label
      >
      <input
        type="number"
        [(ngModel)]="newRow.acciones_planificadas"
        placeholder="Acciones Planificadas"
        name="acciones_planificadas"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        min="0"
        (input)="calcularIndicadorEficacia(newRow)"
      />
    </div>
    <div class="col-6 ps-2 mt-3 flex flex-col">
      <label
        for="accionesRealizadas"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Acciones Realizadas</label
      >
      <input
        type="number"
        [(ngModel)]="newRow.acciones_realizadas"
        placeholder="Acciones Realizadas"
        name="acciones_realizadas"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
        min="0"
        (input)="calcularIndicadorEficacia(newRow)"
      />
    </div>
    <div class="col-6 pe-2 mt-3 flex flex-col">
      <label
        for="indicadorEficacia"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Indicador de Eficacia (%)</label
      >
      <input
        type="number"
        [(ngModel)]="newRow.indicador_eficacia"
        name="indicador_eficacia"
        readonly
        class="w-full px-3 py-2 border rounded-lg focus:outline-none bg-gray-100"
      />
    </div>
    <div class="col-6 ps-2 mt-3 flex flex-col">
      <label
        for="fechaRevison"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Fecha Revisión</label
      >
      <input
        type="date"
        [min]="minDate"
        [max]="maxDate"
        [(ngModel)]="newRow.fecha_revision_efectividad"
        placeholder="Fecha Revisión"
        name="fecha_revision_efectividad"
        required
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-blue-300 resize-none"
      />
    </div>
    <div class="col-6 pe-2 mt-3 flex flex-col">
      <label
        for="fechaCompromiso"
        class="block mb-1 text-sm font-medium text-gray-700"
        >Fechas de Compromiso</label
      >
      <div class="flex items-center space-x-2">
        <input
          type="date"
          [(ngModel)]="fecha"
          [min]="minDate"
          [max]="maxDate"
          [ngModelOptions]="{ standalone: true }"
          class="border border-gray-300 rounded-md p-2 w-full"
        />
        <button-add
          [title]="'Agregar nueva fecha'"
          (click)="addFechaCompromiso()"
          onkeypress=""
        ></button-add>
      </div>
      <div *ngIf="errorMessage">
        <p class="text-red-500 text-sm mt-1">{{ errorMessage }}</p>
      </div>
      <ul class="mt-3 space-y-2">
        <li
          *ngFor="let fecha of newRow.fechas_compromiso; let i = index"
          class="flex items-center justify-between bg-gray-100 p-2 rounded-md"
        >
          <span>{{ fecha }}</span>
          <button-delete
            [title]="'Eliminar fecha'"
            (click)="removeFecha(i, $event)"
            onkeypress=""
          ></button-delete>
        </li>
      </ul>
    </div>
  </div>
  <div class="md:col-span-2 mt-4">
    <button-save [title]="'Guardar Registro'"></button-save>
  </div>
</form>

} @if (viewPdf) {
<div class="flex justify-start mb-4">
  <button-back
    [title]="'Regresar'"
    (click)="mostrarTabla()"
    onkeypress="mostrarTabla()"
  ></button-back>
</div>
<div class="pdf-viewer">
  <iframe
    [src]="pdfUrl"
    width="100%"
    height="700px"
    title="Plan de inspecciones PDF"
  ></iframe>
</div>
} @if (rows.length != 0 && !registrando && !viewPdf) {
<div class="flex mb-4 justify-between px-3">
  <button-save
    (click)="pdfSanitizado()"
    [title]="'Generar Informe PDF'"
    onkeypress="pdfSanitizado()"
  ></button-save>
  <!-- Agregar -->
  <button-add
    [title]="'Agregar Registro'"
    (click)="empezarRegistro()"
    onkeypress=""
  ></button-add>
</div>

<div class="contenedor-tabla table-responsive col-lg-12">
  <div class="tabla-cuerpo">
    <table class="table table-striped tabla-estilos">
      <thead>
        <tr>
          <th scope="col" style="text-align: center">#</th>
          <th scope="col">
            <div class="">Acciones</div>
          </th>
          <th scope="col">
            <div class="">Recursos</div>
          </th>
          <th scope="col">
            <div class="">Responsable</div>
          </th>
          <th scope="col">
            <div class="text-center">Realizadas</div>
          </th>
          <th scope="col">
            <div class="text-center">Planificadas</div>
          </th>
          <th scope="col">
            <div class="text-center">Indicador de Eficiencia</div>
          </th>
          <th scope="col" class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of rows; let i = index; let indice = index">
          <th scope="row">{{ indice + 1 }}</th>
          <td class="content-nombre-user">
            {{ row.descripcion }}
          </td>
          <td>{{ row.recursos }}</td>
          <td>{{ row.responsable }}</td>
          <td class="text-center">
            {{ row.acciones_realizadas }}
          </td>
          <td class="text-center">
            {{ row.acciones_planificadas }}
          </td>
          <td [ngClass]="getEficaciaClass(row.indicador_eficacia)">
            <div class="box-progress-wrapper">
              <div class="box-progress-bar">
                <span
                  class="box-progress"
                  [style.width]="row.indicador_eficacia + '%'"
                  style="background-color: #4067f9"
                ></span>
              </div>
              <p class="box-progress-percentage">
                {{ row.indicador_eficacia }}%
              </p>
            </div>
          </td>
          <td>
            <div class="contenedor-btn-acciones">
              <button-edit
                (click)="editRow(i)"
                [title]="'Editar'"
                onkeypress="editRow(i)"
              ></button-edit>
              <button-delete
                (click)="deleteRow(i)"
                [title]="'Eliminar'"
                onkeypress="deleteRow(i)"
              ></button-delete>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

}
